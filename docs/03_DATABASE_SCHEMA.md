# 3. Database Schema

The MQI Communicator system uses a single SQLite database as a centralized repository for system state, resource management, workflow tracking, and logging. This document details the schema of each table.

The database is self-initializing; the tables described below will be created automatically on first connection if they do not already exist.

## 3.1. `cases`

This is the central table for tracking the state of each individual QA case as it moves through the workflow.

| Column            | Type    | Description                                                                                             |
| ----------------- | ------- | ------------------------------------------------------------------------------------------------------- |
| `case_id`         | TEXT    | **Primary Key.** A unique identifier for the case, typically derived from the case's directory name.      |
| `status`          | TEXT    | The current status of the case. Must be one of: `NEW`, `QUEUED`, `PROCESSING`, `FAILED`, `COMPLETED`, etc. |
| `workflow_step`   | TEXT    | The name of the specific workflow step currently being executed (e.g., `run_interpreter`).                |
| `assigned_gpu_id` | INTEGER | The ID of the GPU resource currently reserved for this case. Foreign key to `gpu_resources.gpu_id`.     |
| `error_message`   | TEXT    | If the case has failed, this field stores the reason for the failure.                                   |
| `last_updated`    | TEXT    | The ISO 8601 timestamp of the last time this record was updated.                                        |
| `created_at`      | TEXT    | The ISO 8601 timestamp of when this record was first created.                                           |

## 3.2. `case_history`

This table provides a complete audit trail of all status changes for every case. A new record is inserted into this table every time the status of a case is updated.

| Column        | Type    | Description                                                                 |
| ------------- | ------- | --------------------------------------------------------------------------- |
| `history_id`  | INTEGER | **Primary Key.** An auto-incrementing ID for the history event.             |
| `case_id`     | TEXT    | The ID of the case this history event belongs to. Foreign key to `cases.case_id`. |
| `status`      | TEXT    | The new status of the case at the time of this event.                       |
| `workflow_step` | TEXT  | The name of the workflow step associated with this history event.           |
| `message`     | TEXT    | A human-readable message describing the event (e.g., "Starting workflow step"). |
| `timestamp`   | TEXT    | The ISO 8601 timestamp of when this history event occurred.                 |

## 3.3. `gpu_resources`

This table tracks the state of all available GPU resources on the remote HPC system. It is used by the `Conductor` to reserve GPUs for processing.

| Column              | Type    | Description                                                                                |
| ------------------- | ------- | ------------------------------------------------------------------------------------------ |
| `gpu_id`            | INTEGER | **Primary Key.** The integer ID of the GPU (e.g., 0, 1, 2).                                |
| `uuid`              | TEXT    | The unique UUID of the GPU, as reported by `nvidia-smi`.                                   |
| `status`            | TEXT    | The current status of the GPU. Must be one of: `available`, `reserved`, `error`.           |
| `reserved_by_case_id` | TEXT  | If status is `reserved`, the `case_id` that has reserved this GPU. Foreign key to `cases.case_id`. |
| `memory_mb`         | INTEGER | The total memory of the GPU in megabytes.                                                  |
| `utilization_percent` | REAL  | The current GPU utilization percentage.                                                    |
| `temperature_celsius` | REAL  | The current GPU temperature in degrees Celsius.                                            |
| `last_updated`      | TEXT    | The ISO 8601 timestamp of the last time this GPU's metrics were updated.                   |

## 3.4. `logs`

This table stores all structured log messages generated by the system's components, providing a centralized and queryable logging store.

| Column           | Type    | Description                                                                 |
| ---------------- | ------- | --------------------------------------------------------------------------- |
| `log_id`         | INTEGER | **Primary Key.** An auto-incrementing ID for the log entry.                 |
| `timestamp`      | TEXT    | The ISO 8601 timestamp of when the log event occurred.                      |
| `component`      | TEXT    | The name of the component that generated the log (e.g., `conductor`, `case_scanner`). |
| `level`          | TEXT    | The log level (e.g., `INFO`, `WARNING`, `ERROR`).                           |
| `correlation_id` | TEXT    | A unique ID that links all log entries related to a single workflow or request. |
| `message`        | TEXT    | The log message, including any stack traces for exceptions.                 |

## 3.5. `scanned_cases`

This table is used by the `CaseScanner` worker to keep a persistent record of all case directories it has already processed. This prevents the system from reprocessing the same case if the worker restarts.

| Column       | Type | Description                                                     |
| ------------ | ---- | --------------------------------------------------------------- |
| `case_path`  | TEXT | **Primary Key.** The full path to the case directory that was scanned. |
| `scanned_at` | TEXT | The ISO 8601 timestamp of when the case was scanned.            |
| `status`     | TEXT | The result of the processing ('processed' or 'failed').         |

## 3.6. `process_status`

This table is used by the `ProcessManager` to track the Process IDs (PIDs) of all running microservice processes. This helps in monitoring the health of the services.

| Column         | Type    | Description                                                     |
| -------------- | ------- | --------------------------------------------------------------- |
| `process_name` | TEXT    | **Primary Key.** The unique name of the process (e.g., `conductor`). |
| `pid`          | INTEGER | The Process ID (PID) of the running service.                    |
| `is_remote`    | BOOLEAN | A flag indicating whether the process is running locally or remotely. |
| `host`         | TEXT    | The hostname where the process is running ('localhost' or a remote host). |
| `last_updated` | TEXT    | The ISO 8601 timestamp of the last time this record was updated.  |

## 3.7. Archive Tables (Proposed)

To prevent the live tables from growing indefinitely, the `Archiver` worker moves old, completed records to these archive tables.

*   **`archived_cases`**: Has the same schema as `cases`.
*   **`archived_case_history`**: Has the same schema as `case_history`.
